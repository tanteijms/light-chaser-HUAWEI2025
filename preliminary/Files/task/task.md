### 边缘集群AI推理的分布式任务调度

**时间限制**: 30s
 ​**​空间限制​**: 512MB

#### 背景信息

在多用户共享算力资源的场景下，由于推理任务的启动时间不同步、性能需求差异显著，加之服务器本身的异构性，系统会面临复杂的调度需求。需要设计调度算法，尽可能满足多个用户的吞吐量需求。

#### 题目描述

多个用户在不同时刻有不同的推理请求，为处理请求提供多种服务器。需要通过把请求放置于服务器上，并采用迁移操作使得尽可能满足吞吐量需求。

**服务器**:

- 提供 `N` 台服务器，第 `i` 台服务器有 `g_i` 个NPU，显存大小是 `m_i` MB。
- 单个服务器的所有NPU是相同的。

**推理耗时**:

- 第 `i` 种服务器的单个NPU同时处理多个请求时，该NPU上的第 `j` 个请求的耗时是 `\lceil \frac{B_j}{f(B_j)} \rceil` 毫秒。
- 其中 `f(B_j) = k_i \times \sqrt{B_j}` 表示推理速度，`k_i` 表示该NPU的推理速度系数，`B_j` 表示第 `j` 个请求的batchsize。
- 请求在第 `x` 毫秒开始推理，推理耗时 `y` 毫秒，则该请求在第 `x + y` 毫秒完成推理。

**显存**:

- Memory `= a \times \text{batchsize} + b` 表示显存与batchsize的关系。
- `b` 是模型相关固有参数。

**模型**:

- 每个请求使用的模型都相同，每个NPU都已预加载该模型。

**用户**:

- 共有 `M` 个用户有推理诉求。
- 第 `i` 个用户希望在第 `[s_i, e_i)` 毫秒内推理cnt_i个样本。

**通信时延**:

- 第 `i` 个用户把请求发送到第 `j` 种服务器的通信时延是 `\text{latency}_{j,i}` 毫秒。
- 用户在第 `x` 毫秒发送请求，服务器在第 `x + \text{latency}_{j,i}` 毫秒收到请求。
- 用户可在第 `x + \text{latency}_{j,i} + 1` 毫秒发送下一个请求。

**迁移次数**:

- 第 `i` 个用户在同一时刻只能发送一个请求，记接收该请求的NPU编号是 `v`。
- 按照时间顺序，该用户发送第一个请求到最后一个请求形成的 `v` 序列是 `V`。
- 记 `V` 的长度是 `L`，则 `\text{move}_i = \sum_{i=1}^{L-1} [V_i \neq V_{i+1}]`。
- 该用户得分随 `\text{move}_i` 增加而减少。

**推理顺序**:
 每个NPU对应一个队列，队列内存储未完成推理的请求。每毫秒处理一次队列。本题最小时间单位是毫秒，不可拆分。队列排序规则：

1. 移除已完成推理的请求。
2. 增加当前时刻接收到的请求。
3. 将序列排序：
   - 第一关键字：请求到达该NPU所在服务器的时刻（越早到达越靠前）。
   - 第二关键字：用户编号（编号越小越靠前）。
4. 从队首至队尾依次扫描请求，若加上该请求所需显存后未超过服务器显存，则分配推理资源。

#### 输入

第一行一个整数 `N` (`1 \leq N \leq 10`) 表示服务器种类数。
 接着 `N` 行，每行3个整数 `g_i(第i台服务器NPU个数), k_i(推理速度参数), m_i(NPU显存大小)` (`1 \leq g_i \leq 10`, `1 \leq k_i \leq 5`, `1000 \leq m_i \leq 2000`)。
 接着一行一个整数 `M` (`1 \leq M \leq 500`) 表示用户数量。
 接着 `M` 行，每行3个整数 `s_i, e_i(表示用户的推理请求时间段[s_i, e_i) ), \text{cnt}_i(cnt_i表示待推理样本数量)` (`0 \leq s_i < e_i \leq 60000`, `1 \leq \text{cnt}_i \leq 6000`, `5 \times \text{cnt}_i \leq e_i - s_i`)。
 接着 `N` 行，每行 `M` 个整数 `\text{latency}_{i,j}` (`10 \leq \text{latency}_{i,j} \leq 20`)。表示第j个用户把请求发送到第i种服务器的通信时延
 最后一行两个整数 `a, b` (`10 \leq a \leq 20`, `100 \leq b \leq 200`)。（表示显存和batchsize的关系）

#### 输出

输出 `2M` 行，第 `2i-1` 行和第 `2i` 行表示第 `i` 个用户的推理方案。

第 `2i-1` 行：整数 `T_i` (`1 \leq T_i \leq 300`)。

```
用户推理请求输出格式说明（第 2i 行）
该行包含 4 × T_i 个整数，共表示 T_i 次推理请求的调度。

每次请求由以下 4 个值组成：

字段位置（第 4j - x 个）	字段名	约束条件
第 4j - 3 个整数	time_j	0 ≤ time_j < time_{j+1} ≤ 1,000,000
time_{T_i+1} = +∞（即最后一个任务之后没有更多任务）
第 4j - 2 个整数	server_j	1 ≤ server_j ≤ N（服务器编号）
第 4j - 1 个整数	NPU_j	1 ≤ NPU_j ≤ g[server_j]（NPU 编号）
第 4j 个整数	B_j	1 ≤ B_j ≤ 1000
并且满足：a × B_j + b ≤ m[server_j]（显存约束）

✅ 额外要求（必须满足）
time_1 ≥ s_i：第一个请求发送时间不早于用户推理起始时间。

所有样本都必须被处理完：
∑_{j=1}^{T_i} B_j = cnt_i。\text{time}_j, \text{server}_j, \text{NPU}_j, B_j
```

- 约束：`\text{time}_1 \geq s_i`, `\sum_{j=1}^{T_i} B_j = \text{cnt}_i`。

#### 评分规则

单个测试用例得分：

```
\text{Score} = h(K) \times \sum_{i=1}^{M} h\left(\frac{\text{end}_i - e_i}{e_i - s_i}\right) \times p(\text{move}_i) \times 10000 
```

其中：

- `\text{end}_i` 表示该用户的最后一个样本推理完成的时刻。
- `K = \sum_{i=1}^{M} [\text{end}_i > e_i]`。
- `h(x) = 2^{-\frac{x}{100}}`。
- `p(x) = 2^{-\frac{x}{200}}`。

#### 样例

**输入**:

```
2  
2 3 10000  
6 5 20000  
3  
0 60000 3000  
10000 50000 2000  
0 200000 5000  
10 20 20  
20 10 12  
10 100  
```

**输出**:

```
1  
0 1 1 3000  
2  
0 1 1 1000 20000 1 2 1000  
2  
0 2 1 1000 100000 1 2 2000  
```

#### 错误类型

1. **基础错误**: 编译错误、异常退出、超时、超内存。
2. 逻辑错误
   - "Invalid Output" (`T_i` 或 `\text{time}_j` 违反约束)。
   - "Batchsize Exceeds Memory" (`B_j` 违反约束)。
   - "Samples Not Fully Processed" (样本未全部发送)。
   - "Invalid Time Order" (`\text{time}_j` 非递增)。
   - "Invalid NPU Index" (NPU编号违反约束)。
   - "Invalid User Send Time" (发送时刻早于 `s_i`)。
   - "Invalid Server Index" (服务器编号违反约束)。