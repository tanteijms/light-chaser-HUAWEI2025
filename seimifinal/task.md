# 边缘集群AI推理的分布式任务调度

**时间限制**: 30s
**空间限制**: 512MB

## 背景信息

在多用户共享算力资源的场景下，由于推理任务的启动时间不同步、性能需求差异显著，加之服务器本身的异构性，系统会面临复杂的调度需求。需要选手设计调度算法，尽可能满足多个用户的吞吐量需求。

## 题目描述

多个用户在不同时刻有不同的推理请求，为处理请求提供多种服务器。选手需要通过把请求放置于服务器上，并采用迁移操作使得尽可能满足吞吐量需求。

以下是相关信息的详细描述:

* **服务器**: 提供 $N$ 台服务器，第 $i$ 台服务器有 $g_{i}$ 个NPU，显存大小是 $m_{i}$ MB。单个服务器的所有NPU是相同的。
* **推理耗时**: 第 $i$ 种服务器的单个NPU同时处理多个请求时，该NPU上的第 $j$ 个请求的耗时是 $\lceil\frac{B_{j}}{f(B_{j})}\rceil$ 毫秒，其中 $f(B_{j})=k_{i}*\sqrt{B_{j}}$ 表示推理速度，$k_{i}$ 表示该NPU的推理速度系数，$B_{j}$ 表示第 $j$ 个请求的batchsize。请求在第 $x$ 毫秒开始推理，推理耗时 $y$ 毫秒，则该请求在第 $x+y$ 毫秒完成推理。不考虑模型加载耗时。
* **显存**: $Memory=a_{i}*batchsize+b_{i}$ 表示显存与batchsize的关系，$a_{i}$, $b_{i}$ 表示第 $i$ 个用户使用的模型的固有参数。
* **用户**: 共有 $M$ 个用户有推理诉求。其中第 $i$ 个用户希望在第 $[s_{i},e_{i})$ 毫秒内推理 $cnt_{i}$ 个样本。
* **通信时延**: 第 $i$ 个用户把请求发送到第 $j$ 种服务器的通信时延是 $latency_{j,i}$ 毫秒，即用户在第 $x$ 毫秒发送请求，服务器在第 $x+latency_{j,i}$ 毫秒收到请求。用户可在第 $x+latency_{j,i}+1$ 毫秒发送下一个请求。
* **迁移次数**: 形式化地，第 $i$ 个用户在同一时刻只能发送一个请求，记接收该请求的NPU编号是 $v$。按照时间顺序，该用户发送第一个请求到最后一个请求形成的 $v$ 序列是 $V$。记 $V$ 的长度是 $L$，$move_{i}=\sum_{i=1}^{L-1}[V_{i}!=V_{i+1}]$，则该用户得分随 $move_i$ 增加而减少，具体细节见评分规则。
* **推理顺序**: 每个NPU对应一个队列，队列内存储**未完成推理**的请求。队列排序的第一关键字是请求到达该NPU所在服务器的时刻，越早到达的请求越靠近队首。对于同时到达的请求，编号越小的用户发送的请求越靠近队首。每毫秒会处理一次队列。按照先后顺序执行的处理方式如下:
    * 移除已完成推理的请求。
    * 增加当前时刻接收到的请求。
    * 将序列排序。
    * 从队首至队尾依次扫描请求，若加上该请求所需显存后未超过服务器显存，则认为本毫秒对该请求分配推理资源。
* **备注**: 本题的最小时间单位是毫秒，不可拆分。

## 题目交互

### 输入

1.  第一行一个整数 $N(1\le N\le10)$ 表示服务器种类数。
2.  接着 $N$ 行，每行3个整数 $g_{i},k_{i},m_{i}(1\le g_{i}\le10,1\le k_{i}\le5,1000\le m_{i}\le2000)$，其中 $g_{i}$ 表示第 $i$ 台服务器NPU个数，$k_{i}$ 表示推理速度参数，$m_{i}$ 表示NPU显存大小。与上文"服务器"含义一致。
3.  接着一行，该行一个整数 $M(1\le M\le500)$ 表示用户数量。
4.  接着 $M$ 行，每行3个整数 $s_{i},e_{i},cnt_{i}(0\le s_{i}<e_{i}\le60000,1\le cnt_{i}\le6000,5\times cnt_{i}\le e_{i}-s_{i})$，其中 $s_{i},e_{i}$ 表示用户的推理请求时间段 $[s_{i},e_{i})$，$cnt_{i}$ 表示待推理样本数量。
5.  接着 $N$ 行，每行 $M$ 个整数，其中第 $i$ 行第 $j$ 个整数 $latency_{i,j}(10\le latency_{i,j}\le20)$。表示第 $j$ 个用户把请求发送到第 $i$ 种服务器的通信时延。
6.  接着 $M$ 行，每行2个整数 $a_{i},b_{i}(10\le a_{i}\le20,100\le b_{i}\le200)$。表示第 $i$ 个用户使用的模型的显存和batchsize的关系。

### 输出

输出 $2M$ 行，第 $2i-1$ 行和第 $2i$ 行表示第 $i$ 个用户的推理方案。

1.  第 $2i-1$ 行包含一个整数 $T_{i}$，需要保证 $1 \le T_{i} \le 300$。
2.  第 $2i$ 行包含 $4T_{i}$ 个整数。
    * 第 $4j-3$ 个整数 $time_{j}(0\le time_{j}<time_{j+1}\le1000000,time_{T_{i}+1}=+\infty)$。
    * 第 $4j-2$ 个整数 $server_{j}(1\le server_{j}\le N)$。
    * 第 $4j-1$ 个整数 $NPU_{j}(1\le NPU_{j}\le g_i)$。
    * 第 $4j$ 个整数 $B_{j}(1\le B_{j}\le1000)$, 需满足 $a_{i}\times B_{j}+b_{i}\le m_{server_{j}}$。
    * 表示第 $i$ 个用户在 $time_{j}$ 时刻将包含 $B_{j}$ 个推理样本的请求发送给第 $server_{j}$ 台服务器的第 $NPU_{j}$ 个NPU。
    * 选手需保证 $time_{1}\ge s_{i},\sum_{j=1}^{T_{i}}B_{j}=cnt_{i}$。

## 评分规则

单个测试用例得分:
$Score=h(K)\times\sum_{i=1}^{M}h(\frac{end_{i}-e_{i}}{e_{i}-s_{i}})\times p(move_{i})\times10000$

其中 $end_{i}$ 表示该用户的最后一个样本推理完成的时刻。
$K=\sum_{i=1}^{M}[end_{i}>e_{i}]$
$h(x)=2^{-\frac{x}{100}}$
$p(x)=2^{-\frac{x}{200}}$

选手总得分为所有测试用例得分之和。

## 样例

### 输入

```
2
2 3 10000
6 5 20000
3
0 60000 3000
10000 50000 2000
0 200000 5000
10 20 20
20 10 12
10 100
```

### 输出

```
1
0 1 1 3000
2
0 1 1 1000 20000 1 2 1000
2
0 2 1 1000 100000 1 2 2000
```

**备注**: 输入输出仅为说明格式。

## 错误类型

### 基础错误类型

1.  代码编译错误
2.  程序异常退出 (可能原因: 运行错误, 使用异常权限, 输出参数比实际多, 输出参数格式不对, etc...)
3.  超出时间限制 (可能原因: 交互时未使用清空流缓存命令, 程序运行超时, 输出参数比实际少, etc...)
4.  超出内存限制

### 逻辑错误类型

* "Unknown Error" (出现时请联系大赛方)
* "RE" (程序内存访问越界或异常退出)
* "Invalid Output" (T或者time 违反约束)
* "Batchsize Exceeds Memory" (B;违反约束)
* "Samples Not Fully Processed" (样本未全部发送)
* "Invalid Time Order" (time 非递增)
* "Invalid NPU Index" (NPU编号违反约束)
* "Invalid User Send Time" (样本发送时刻早于允许发送的时刻)
* "Invalid Server Index" (服务器编号违反约束)